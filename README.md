# Triple Oscillator Synth

A Triple oscillator synthesizer built with Python and PyQt5. Three independent oscillators with multiple waveforms, ADSR envelope shaping, and a resonant low-pass filter.

![Triple Oscillator Synth](screenshot.png)

## Purpose
> this section is writen by a human! ðŸ•º

I am a evolutionary biologist and bioinformatician who loves synthesizers. I am also both fascinated (and concerned!) about the way AI is transforming research and our lives. I am using this project to get a first hand feel for what can be done "vibe-coding", and I am hoping to use this project as a stepping stone to build a hardware, microcontroller-based, synth and a VST plugin. 

- All the code, libraries and documentation generated here is meant ti be always free and open access. 
- I will also try to produce documentation related to the development of the synth (code workflow, signal flow, audio processing flow) and other educational material.
- In order to prevent AI models to train themselves on AI-generated content, I have added disclaimers in the code and currently prevent AI crawlers from scraping this repository with `robots.txt`

## AI Training Disclaimer

âš ï¸ **Notice**: This project is developed with AI assistance (["vibe-coded"](https://en.wikipedia.org/wiki/Vibe_coding#:~:text=In%20September%202025%2C%20Fast%20Company,AI%2Dgenerated%20vibe%2Dcode.)). 
I strongly discourage using the code in this repository for the purpose of training AI models

## Features
> this section and everything below is for most part writen and generated by a robot! ðŸ¤–

### Oscillators
- **3 Independent Oscillators**
- **3 Waveforms per Oscillator**:
  - Sine: Pure, smooth tones
  - Sawtooth: Bright, buzzy sounds (PolyBLEP anti-aliased)
  - Square: Hollow, clarinet-like tones with pulse width modulation (PolyBLEP anti-aliased)
- **Pulse Width Modulation (PWM)**: Adjustable duty cycle for square waves (1-99%)
  - Creates timbres from thin/nasal to thick/hollow
  - Independent PWM control per oscillator
  - Real-time modulation for classic analog synthesizer sounds
- **Frequency Range**: 20 Hz to 5000 Hz (logarithmic scale)
- **Dual Playback Modes**:
  - **Chromatic Mode** (default): Frequency knobs control detune in cents (-100 to +100), play notes via MIDI/computer keyboard
  - **Drone Mode**: Frequency knobs control absolute frequency (20Hz-5kHz), oscillator ON buttons trigger sound
- **Octave Switches**: Independent octave controls per oscillator (-3 to +3 octaves, disabled in drone mode)
- **Real-time Frequency Adjustment**: Smooth frequency changes without clicks
- **Individual On/Off Controls**: Per-oscillator activation with visual feedback
- **PolyBLEP Anti-Aliasing**: Band-limited waveform generation eliminates harsh aliasing artifacts from sawtooth/square waves
- **Phase Preservation**: Oscillators maintain phase continuity during voice stealing for click-free transitions

### Voice Modes & Polyphony
- **2 Playback Modes**: CHROM (chromatic) / DRONE mode switch
  - **CHROM**: Note-based playback with detune controls in cents
  - **DRONE**: Continuous tone generation with absolute frequency controls
- **3 Voice Modes**: Simple one-click mode selection
  - **MONO**: Monophonic - Single voice, classic synth behavior
  - **POLY**: Polyphonic - Up to 8 simultaneous voices
  - **UNI**: Unison - 8 detuned voices for supersaw/chorus effect
- **Computer Keyboard Input**: Play notes using your QWERTY keyboard (piano layout)
- **MIDI Keyboard Support**: Full MIDI keyboard integration
- **Voice Stealing**: Intelligent voice management with LRU algorithm
- **Per-Voice Envelopes**: Each voice has independent ADSR envelopes

### MIDI Support
- **MIDI Keyboard Input**: Play notes with any MIDI keyboard
- **Chromatic Mode Integration**: Works seamlessly with MIDI or computer keyboard input
- **Octave Layering**: Combine oscillators at different octaves for rich harmonic textures

### Mixer
- **3-Channel Mixer**: Independent volume control (0-100%) for each oscillator
- **Master Volume**: Global output level control (0-100%)
- **Real-time Mixing**: Adjust oscillator levels on the fly

### ADSR Envelope Generator
- **Attack**: 0-2000ms - Control how quickly the sound fades in (default: 0ms, min 5ms anti-click)
- **Decay**: 0-2000ms - Control how quickly it drops to sustain level
- **Sustain**: 0-100% - Set the held level
- **Release**: 0-5000ms - Control fade-out time after note off (default: 300ms)
- **Post-Mixer Architecture**: Single envelope applied after oscillator mixing for efficiency
- **Per-Voice Envelopes**: In poly/unison modes, each voice has independent envelopes
- **Legato Retriggering**: Smooth envelope transitions when stealing voices (analog synth behavior)
- **Real-time Updates**: ADSR changes affect all active voices immediately
- **Anti-Click Protection**: Minimum 5ms attack prevents discontinuities

### Multi-Mode Moog Ladder Filter
- **Filter Modes**: LP (Low-Pass), BP (Band-Pass), HP (High-Pass) with dedicated toggle buttons
- **Cutoff Frequency**: 20-20000 Hz - Full audible spectrum range (logarithmic scale)
- **Resonance**: 0-100% - Emphasize the cutoff frequency for classic analog character
- **4-Pole Ladder Design**: Moog-style cascade topology with 24dB/octave rolloff (LP mode)
- **Analog-Style Response**:
  - LP: 24dB/octave steep rolloff from 4th stage
  - BP: 12dB/octave with resonant peak from 2nd stage
  - HP: Proper high-pass by subtraction with aggressive bass removal
- **Resonance Feedback**: Classic Moog topology with feedback from output to input
- **Artifact-Free**: Advanced state management prevents instability at high resonance
- **Smooth Parameter Changes**: No clicks when sweeping cutoff, resonance, or switching modes
- **Coefficient Caching**: Only recalculates when parameters change for optimal performance

### LFO (Low-Frequency Oscillator)
- **3 Waveforms**: Sine, Triangle, Square for different modulation shapes
- **Dual Sync Modes**:
  - **Free Mode**: Manual Hz control (0.1-20 Hz)
  - **Sync Mode**: Tempo-synced divisions (1/16, 1/8, 1/4, 1/2, 1/1, 2/1, 4/1)
- **MIDI Clock Integration**: Automatic BPM detection from MIDI clock messages
  - BPM knob disabled in Sync mode (controlled by MIDI tempo)
  - Real-time tempo tracking from DAW/sequencer
  - Smooth BPM averaging for stable sync
- **10 Modulation Targets**: Comprehensive routing matrix
  - **Pitch** (Osc 1, 2, 3): Vibrato and frequency modulation
  - **Pulse Width** (Osc 1, 2, 3): Dynamic timbral movement
  - **Volume** (Osc 1, 2, 3): Tremolo and amplitude modulation
  - **Filter Cutoff**: Sweeping filter effects
- **Dual Controls per Target**:
  - **Depth**: Amount of modulation (0-100%)
  - **Mix**: Dry/wet blend (0-100%) for each assignment independently
- **Real-time Modulation**: All parameters update instantly during playback
- **JUNO-106 Style Interface**: Vertical sliders with tick marks for precise control

### Noise Generator
- **3 Noise Types**: White, Pink (1/f), and Brown (Brownian) noise
- **Independent Control**: On/off toggle, type selector, and gain knob
- **Envelope Integration**: Shares ADSR settings with oscillators
- **Dual Mode Operation**:
  - **Chromatic Mode**: Triggered by keyboard/MIDI note events
  - **Drone Mode**: Triggered by noise ON/OFF button
- **4th Oscillator**: Behaves as an additional sound source alongside the 3 main oscillators

### Spectrum Analyzer
- **Real-time FFT Analysis**: 2048-point FFT with 30 FPS display
- **Popup Window**: Resizable landscape window with keyboard MIDI passthrough
- **Fixed Scales**: Industry-standard frequency and amplitude ranges
  - Y-axis: -90 to +100 dB (fixed, non-dynamic)
  - X-axis: 20 Hz to 20 kHz logarithmic scale
- **Conventional Frequency Marks**: 20, 50, 100, 200, 500, 1k, 2k, 5k, 10k, 20k Hz
- **Hann Windowing**: Reduces spectral leakage for accurate frequency representation
- **Exponential Smoothing**: Smoothed display for better readability
- **Keyboard-Friendly**: Forward all keyboard events to main synth window for uninterrupted playing

### Level Meter
- **Real-time Peak Display**: Horizontal bar meter with fast attack, slow decay
- **Absolute Color Thresholds**: Professional metering standards
  - Green: 0-70% (safe operating level)
  - Yellow: 70-85% (approaching limit)
  - Red: 85-100% (near clipping)
- **Clip Indicator**: Red "CLIP" light when signal reaches Â±1.0
- **1-Second Hold**: Clip indicator remains visible for 1 second after clipping
- **Pre-Clipping Detection**: Monitors signal before safety limiter for accurate indication

### Preset Management
- **Save Presets**: Save all synth settings to JSON files
- **Load Presets**: Recall saved settings instantly
- **Forward Compatible**: Old presets work with new features via smart defaults
- **Human Readable**: JSON format allows manual editing
- **Complete State**: Saves oscillators, envelope, filter, noise, voice mode, playback mode, and master settings

### Audio Engine
- **44.1 kHz Sample Rate**: CD-quality audio
- **Phase-Continuous Generation**: Click-free frequency changes
- **Real-time Processing**: Low-latency audio synthesis

## Installation

### Prerequisites
- Python 3.7 or higher
- pip (Python package manager)

### Setup

1. Clone the repository:
```bash
git clone https://github.com/clemgoub/TripleOscillator.git
cd TripleOscillator
```

2. Create a virtual environment:
```bash
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

3. Install dependencies:
```bash
pip install -r requirements.txt
```

## Usage

Run the synthesizer:
```bash
./venv/bin/python sine_generator_qt.py
```

### Creating Sounds

**Pluck Sound:**
- Attack: 5ms, Decay: 200ms, Sustain: 0%, Release: 100ms
- Cutoff: 2000 Hz, Resonance: 0%
- Oscillator 1: Square wave
- Click ON button to trigger a pluck sound

**Pad Sound:**
- Attack: 800ms, Decay: 500ms, Sustain: 60%, Release: 1500ms
- Cutoff: 1500 Hz, Resonance: 30%
- Oscillators 1-3: All Sine waves, slightly detuned (e.g., 440, 442, 444 Hz)
- Creates a lush, evolving pad

**Bass Sound:**
- Attack: 1ms, Decay: 300ms, Sustain: 40%, Release: 200ms
- Cutoff: 400 Hz, Resonance: 10%
- Oscillator 1: Sawtooth @ 110 Hz
- Fat, punchy bass tone

**Detune Effect:**
- Set 2-3 oscillators to slightly different frequencies (e.g., 440, 442, 444 Hz)
- Creates a chorus/detuned effect with natural beating

## Architecture

### Code Architecture

```mermaid
classDiagram
    class SineWaveGenerator {
        +sample_rate: int
        +freq1, freq2, freq3: float
        +detune1, detune2, detune3: float
        +octave1, octave2, octave3: int
        +pulse_width1, pulse_width2, pulse_width3: float
        +waveform1, waveform2, waveform3: str
        +gain1, gain2, gain3: float
        +osc1_on, osc2_on, osc3_on: bool
        +voice_pool: list~Voice~
        +max_polyphony: int
        +unison_count: int
        +env: EnvelopeGenerator
        +noise: NoiseGenerator
        +filter: MoogLadderFilter
        +midi_handler: MIDIHandler
        +init_ui()
        +audio_callback()
        +set_voice_mode(mode)
        +reallocate_voice_pool()
        +handle_note_on(note)
        +handle_note_off(note)
        +toggle_oscillator()
        +poly_blep_vectorized(t, dt)
        +generate_waveform()
        +process_oscillator(osc_num, voice, ...)
        +steal_voice()
        +apply_detune()
        +apply_octave()
        +update_pulse_width()
        +update_adsr()
        +save_preset()
        +load_preset()
        +update_ui_from_preset()
    }

    class Voice {
        +note: int
        +velocity: float
        +phase1, phase2, phase3: float
        +unison_detune: float
        +env: EnvelopeGenerator
        +age: int
        +is_active()
        +trigger(note, velocity, detune, phase_offset)
        +release()
    }

    class NoiseGenerator {
        +noise_type: str
        +envelope: EnvelopeGenerator
        +generate(num_samples)
        +trigger()
        +release()
    }

    class MIDIHandler {
        +port: MIDIPort
        +running: bool
        +note_on: Signal
        +note_off: Signal
        +bpm_changed: Signal
        +start(port_name)
        +stop()
    }

    class EnvelopeGenerator {
        +attack: float
        +decay: float
        +sustain: float
        +release: float
        +phase: str
        +level: float
        +trigger()
        +release_note()
        +force_reset()
        +process(num_samples)
    }

    class MoogLadderFilter {
        +cutoff: float
        +resonance: float
        +filter_mode: str
        +stage1_state: float
        +stage2_state: float
        +stage3_state: float
        +stage4_state: float
        +g: float
        +feedback_gain: float
        +process(input_signal)
        +reset()
    }

    SineWaveGenerator "1" --> "1" EnvelopeGenerator : template
    SineWaveGenerator "1" --> "8" Voice : voice pool
    SineWaveGenerator "1" --> "1" NoiseGenerator : contains
    SineWaveGenerator "1" --> "1" MoogLadderFilter : contains
    SineWaveGenerator "1" --> "1" MIDIHandler : contains
    Voice "1" --> "1" EnvelopeGenerator : post-mixer envelope
    NoiseGenerator "1" --> "1" EnvelopeGenerator : noise envelope
```

### Signal Flow

```mermaid
graph LR
    MIDI[MIDI/Computer<br/>Keyboard] -.->|note events| VM[Voice Manager]
    VM --> VP[Voice Pool<br/>Up to 8 Voices]

    VP --> V1[Voice 1<br/>3 Oscillators<br/>1 Envelope]
    VP --> V2[Voice 2<br/>3 Oscillators<br/>1 Envelope]
    VP --> V3[Voice N...<br/>3 Oscillators<br/>1 Envelope]

    NOISE[Noise Generator<br/>White/Pink/Brown<br/>1 Envelope] --> MIX

    V1 --> MIX[Mixer<br/>Sum All Voices + Noise]
    V2 --> MIX
    V3 --> MIX

    MIX --> FILT[Moog Ladder Filter<br/>LP/BP/HP Modes<br/>Cutoff + Resonance]
    FILT --> OUT[Audio Output<br/>Stereo 44.1kHz]

    UI[UI Controls] -.->|voice mode| VM
    UI -.->|waveforms| VP
    UI -.->|detune/octave| VP
    UI -.->|ADSR params| VP
    UI -.->|noise on/type/gain| NOISE
    UI -.->|gain| MIX
    UI -.->|cutoff/resonance| FILT

    PRESET[Preset System<br/>JSON Files] -.->|load| UI
    UI -.->|save| PRESET
```

### Audio Processing Flow

```mermaid
sequenceDiagram
    participant INPUT as MIDI/Keyboard Input
    participant UI as User Interface
    participant VM as Voice Manager
    participant VOICE as Voice (with 3 OSC + 1 ENV)
    participant FILT as Moog Ladder Filter
    participant OUT as Audio Output

    UI->>VM: Set voice mode (MONO/POLY/UNI)
    UI->>VOICE: Set ADSR params (all voices)
    UI->>FILT: Set mode (LP/BP/HP), cutoff, resonance

    INPUT->>VM: Note On (MIDI note 60, velocity 100)

    alt MONO Mode
        VM->>VOICE: Allocate single voice
        VM->>VOICE: Trigger voice (note 60)
    else POLY Mode
        VM->>VOICE: Find free voice or steal oldest
        VM->>VOICE: Trigger voice (note 60)
    else UNI Mode
        VM->>VOICE: Trigger 8 voices (all note 60)
        VM->>VOICE: Apply detune spread (-20 to +20 cents)
    end

    loop Every Audio Buffer
        VOICE->>VOICE: Generate 3 waveforms (sine/saw/square)
        VOICE->>VOICE: Apply detune + octave offsets
        VOICE->>VOICE: Mix 3 oscillators with gain
        VOICE->>VOICE: Apply single ADSR envelope to mixed signal
        VOICE->>VM: Return voice audio
        VM->>VM: Sum all active voices
        VM->>VM: Add noise generator (if enabled, with envelope)
        VM->>FILT: Apply Moog ladder filter (LP/BP/HP mode)
        FILT->>OUT: Output stereo audio
    end

    INPUT->>VM: Note Off (MIDI note 60)
    VM->>VOICE: Release matching voice(s)
    VOICE->>VOICE: Start release phase
    VOICE->>VOICE: Continue until envelope idle
    VOICE->>VM: Mark voice as free (note = None)
```

### Components

**Voice Management**
- Pre-allocated voice pool (up to 8 voices)
- Voice stealing with LRU (Least Recently Used) algorithm
- Three voice modes: MONO (1 voice), POLY (8 voices), UNI (8 detuned voices)
- Each voice has independent oscillators and phase accumulators
- **Post-Mixer Envelope Architecture**: Single envelope applied after oscillator mixing for efficiency

**Oscillator**
- Generates waveforms using phase accumulation
- Maintains phase continuity across frequency changes
- Supports sine, sawtooth, and square waveforms with PWM
- Independent per-voice oscillators for true polyphony
- Three oscillators per voice, mixed before envelope application

**ADSR Envelope**
- State machine with 5 phases: idle, attack, decay, sustain, release
- Linear interpolation between envelope stages
- **Single envelope per voice** applied post-mixer (efficient architecture matching analog synths)
- Real-time parameter updates affect all active voices
- Proper release phase management for natural note decay

**Noise Generator**
- Paul Kellet's pink noise algorithm for 1/f spectrum
- Brownian noise via integration for warm, bass-heavy texture
- Independent envelope synchronized with oscillator ADSR
- Behaves as 4th oscillator with chromatic/drone mode support

**Moog Ladder Filter**
- 4-pole cascade topology with resonance feedback (classic Moog design)
- Three filter modes: LP (24dB/octave), BP (12dB/octave), HP (high-pass by subtraction)
- Adjustable cutoff frequency (20-20000 Hz) and resonance (0-100%)
- **Proper HP implementation**: Uses correct input reference for mathematically accurate high-pass response
- **Stability protection**: Feedback gain limiting prevents self-oscillation
- **Artifact-free operation**: State management eliminates instability at high resonance
- Applied globally after voice and noise mixing

## Project Structure

```
sine-synth/
â”œâ”€â”€ sine_generator_qt.py    # Main synthesizer application
â”œâ”€â”€ sine_generator.py        # Legacy tkinter version
â”œâ”€â”€ requirements.txt         # Python dependencies
â”œâ”€â”€ README.md               # This file
â””â”€â”€ venv/                   # Virtual environment (not in repo)
```

## Requirements

- Python 3.7+
- numpy >= 1.20.0
- scipy >= 1.7.0
- sounddevice >= 0.4.5
- PyQt5 >= 5.15.0
- mido >= 1.3.0
- python-rtmidi >= 1.5.0

## Development Journey

This project started as a simple sine wave generator and evolved into a full subtractive synthesizer. Key milestones:

1. **Initial Implementation**: Single sine wave oscillator with tkinter GUI
2. **PyQt5 Migration**: Professional GUI with QDial controls
3. **Multiple Oscillators**: Expanded to 3 oscillators with waveform selection
4. **ADSR Envelope**: Added amplitude envelope shaping
5. **Filter**: Implemented resonant low-pass filter
6. **MIDI Support**: Added MIDI keyboard input with dual-mode frequency/detune controls
7. **Octave Switches**: Implemented independent octave controls per oscillator
8. **UI Polish**: Power button, master volume, and refined circular button styling
9. **Pulse Width Modulation**: Added PWM controls for square waves (1-99% duty cycle)
10. **Preset Management**: Implemented forward-compatible preset save/load system
11. **Polyphony & Unison**: Added computer keyboard input, voice modes (MONO/POLY/UNI), per-voice envelopes, and intelligent voice management
12. **Two-Row Layout**: Redesigned UI with horizontal sections for better screen utilization and JUNO-106 style vertical sliders for ADSR
13. **LFO Mix Controls**: Implemented dual-slider interface with depth and dry/wet controls for all 10 modulation targets
14. **Noise Generator**: Added white/pink/brown noise as independent 4th oscillator with envelope integration
15. **Architecture Refactoring**: Migrated from per-oscillator envelopes to single post-mixer envelope (3x efficiency improvement)
16. **Filter Stability**: Implemented advanced biquad filter with Q limiting, state protection, and artifact-free parameter sweeping
17. **Performance Optimizations** (Phase 1-3): Python optimization for future hardware porting
    - **Phase 1 - Performance**: LFO mean caching (7â†’1 calls), filter coefficient caching, magic numbers â†’ constants
    - **Phase 2 - Code Quality**: Oscillator deduplication (~90 lines â†’ 3 lines with `process_oscillator()` helper)
    - **Phase 3 - Audio Quality**: Reduced max filter Q (15â†’10), envelope anti-click (1ms minimum attack)
18. **Unison Mode Fix**: Implemented voice count normalization for all modes (fixed 8x loudness issue in unison)
19. **Comprehensive Preset System**: Enhanced preset format v1.1 with complete parameter coverage
    - Fixed oscillator on/off state saving (runtime state vs stale state bug)
    - Added LFO and ADSR slider UI updates when loading presets
    - Fixed preset name display for both Load button and preset browser
    - Created Init.json and SuperSaw.json demo presets
    - All synth parameters now save/load correctly (oscillators, LFO, noise, voice modes, envelopes, filter)
20. **Audio Quality Overhaul**: Professional-grade click/artifact elimination
    - **PolyBLEP Anti-Aliasing**: Vectorized band-limited waveform generation for sawtooth/square waves eliminates harsh aliasing
    - **Click-Free Note Triggering**: Zero-crossing phase start for fresh notes, 5ms minimum attack envelope
    - **Voice Stealing Optimization**: Legato envelope retriggering + phase preservation (analog synth behavior) for smooth voice transitions
    - **Vectorized Processing**: DC blocker and PolyBLEP now use NumPy operations (100-1000x faster, eliminates crackling)
    - **Filter Stability**: Removed state recomputation on coefficient changes, preventing pops during parameter sweeps
    - **Output Protection**: Final clipping protection prevents overload artifacts
21. **Spectrum Analyzer & Level Meter**: Real-time audio analysis and monitoring
    - **FFT Spectrum Analyzer**: Popup window with 2048-point FFT, fixed scales (-90 to +100 dB, 20 Hz-20 kHz)
    - **Keyboard MIDI Passthrough**: Spectrum window forwards keyboard events for uninterrupted playing
    - **Professional Metering**: Color-coded level meter (green/yellow/red) with absolute thresholds
    - **Clip Detection**: 1-second hold clip indicator for signal overload detection
    - **Resizable Display**: Spectrum window maintains fixed scales when resized
22. **Moog Ladder Filter Implementation**: Replaced biquad with classic 4-pole Moog ladder topology
    - **Three Filter Modes**: LP (24dB/octave), BP (12dB/octave), HP (high-pass) with toggle buttons
    - **Extended Cutoff Range**: 20-20kHz (full audible spectrum) with logarithmic scaling
    - **Resonance Feedback**: Classic Moog topology with feedback from output to input (0-3.5 range)
    - **Critical Bug Fix**: Corrected HP mode to use proper input reference (input_sample vs input_signal)
    - **Analog-Style Response**: LP from stage 4, BP from stage 2, HP by subtraction with correct phase
    - **Preset Compatibility**: Version 1.2 format saves filter mode, backward compatible with old presets

## Roadmap

Future enhancements:
- [x] MIDI input support for playing with a keyboard
- [x] Octave switches for easier musical note selection
- [x] Pulse width modulation for square waves
- [x] Preset management (save/load patches)
- [x] Polyphonic voice support (MONO/POLY/UNI modes)
- [x] Computer keyboard input for playing notes
- [x] LFO (Low-Frequency Oscillator) for modulation
- [x] Create comprehensive demo presets (Init, SuperSaw)
- [x] Additional filter types (LP/BP/HP multi-mode Moog ladder filter)
- [ ] Fine tune knobs
- [ ] Center tune knobs % to top instead of right
- [ ] Effects (reverb, delay, distortion)
- [ ] VST plugin export

## License

MIT License - feel free to use and modify!

## Credits

Built as a learning project exploring audio synthesis, in majority [vibecoded](https://en.wikipedia.org/wiki/Vibe_coding#:~:text=In%20September%202025%2C%20Fast%20Company,AI%2Dgenerated%20vibe%2Dcode.) using Claude code.
